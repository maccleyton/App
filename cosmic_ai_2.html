<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA C√≥smica - Jogo Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1047 50%, #2d1b69 100%);
            color: #e0e0e0; overflow: hidden;
        }
        .container { display: flex; height: 100vh; width: 100vw; }
        .sidebar {
            width: 280px; background: rgba(15, 15, 35, 0.95);
            border-right: 2px solid rgba(100, 200, 255, 0.3);
            display: flex; flex-direction: column; backdrop-filter: blur(10px);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5); overflow-y: auto;
        }
        .header {
            padding: 20px; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-bottom: 2px solid rgba(100, 200, 255, 0.5); text-align: center;
        }
        .header h1 { font-size: 1.4em; margin-bottom: 5px; text-shadow: 0 0 10px rgba(100, 200, 255, 0.8); }
        .header p { font-size: 0.85em; opacity: 0.9; }
        .level-display {
            padding: 10px; background: rgba(100, 200, 255, 0.1);
            border-bottom: 1px solid rgba(100, 200, 255, 0.2); text-align: center;
        }
        .level-display .level { font-size: 1.2em; color: #64c8ff; font-weight: bold; }
        .level-display .score { font-size: 0.9em; color: #888; margin-top: 5px; }
        .nav-section { padding: 15px; border-bottom: 1px solid rgba(100, 200, 255, 0.2); }
        .nav-section h3 { font-size: 0.9em; color: #64c8ff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .nav-button {
            width: 100%; padding: 12px; margin: 5px 0; background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 8px; color: #e0e0e0;
            cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; text-align: left;
        }
        .nav-button:hover { background: rgba(100, 200, 255, 0.2); border-color: rgba(100, 200, 255, 0.6); transform: translateX(5px); box-shadow: 0 0 15px rgba(100, 200, 255, 0.4); }
        .nav-button.active { background: linear-gradient(90deg, rgba(106, 17, 203, 0.5) 0%, rgba(37, 117, 252, 0.5) 100%); border-color: #64c8ff; }
        .nav-button.locked { opacity: 0.5; cursor: not-allowed; border-color: rgba(100, 200, 255, 0.1); }
        .nav-button.locked:hover { background: rgba(100, 200, 255, 0.1); border-color: rgba(100, 200, 255, 0.1); transform: none; box-shadow: none; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar {
            height: 60px; background: rgba(15, 15, 35, 0.9);
            border-bottom: 2px solid rgba(100, 200, 255, 0.3);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; backdrop-filter: blur(10px);
        }
        .status-indicators { display: flex; gap: 20px; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        .status-dot.green { background: #00ff88; } .status-dot.blue { background: #00ccff; } .status-dot.purple { background: #cc00ff; } .status-dot.red { background: #ff4444; }
        @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }
        .content-area { flex: 1; display: flex; position: relative; overflow: hidden; }
        .canvas-container { flex: 1; position: relative; background: radial-gradient(ellipse at center, #0f0a1f 0%, #000000 100%); }
        #cosmicCanvas { width: 100%; height: 100%; cursor: grab; } #cosmicCanvas:active { cursor: grabbing; }
        .canvas-controls {
            position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px;
            background: rgba(15, 15, 35, 0.9); padding: 15px; border-radius: 12px;
            border: 1px solid rgba(100, 200, 255, 0.3); backdrop-filter: blur(10px);
        }
        .control-btn {
            width: 40px; height: 40px; background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 8px; color: #64c8ff;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; transition: all 0.3s ease;
        }
        .control-btn:hover { background: rgba(100, 200, 255, 0.3); border-color: #64c8ff; transform: scale(1.1); }
        .zoom-display { padding: 10px 15px; background: rgba(100, 200, 255, 0.1); border-radius: 8px; color: #64c8ff; font-size: 0.9em; display: flex; align-items: center; border: 1px solid rgba(100, 200, 255, 0.3); }
        .info-panel { width: 350px; background: rgba(15, 15, 35, 0.95); border-left: 2px solid rgba(100, 200, 255, 0.3); padding: 20px; overflow-y: auto; backdrop-filter: blur(10px); }
        .info-panel h2 { font-size: 1.2em; margin-bottom: 15px; color: #64c8ff; border-bottom: 2px solid rgba(100, 200, 255, 0.3); padding-bottom: 10px; }
        .info-card { background: rgba(100, 200, 255, 0.1); border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .info-card h3 { font-size: 1em; color: #a0d8ff; margin-bottom: 10px; }
        .info-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9em; }
        .info-label { color: #888; } .info-value { color: #e0e0e0; font-weight: bold; } .info-value.negative { color: #ff4444; }
        .progress-bar { width: 100%; height: 8px; background: rgba(0, 0, 0, 0.5); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); transition: width 0.5s ease; }
        .action-button { width: 100%; padding: 12px; margin: 10px 0; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(37, 117, 252, 0.5); } .action-button:active { transform: translateY(0); } .action-button.secondary { background: rgba(100, 200, 255, 0.2); border: 1px solid rgba(100, 200, 255, 0.4); }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .experiment-list { list-style: none; } .experiment-item { background: rgba(100, 200, 255, 0.05); padding: 10px; margin: 8px 0; border-radius: 6px; border-left: 3px solid #2575fc; cursor: pointer; transition: all 0.3s ease; }
        .experiment-item:hover { background: rgba(100, 200, 255, 0.15); transform: translateX(5px); } .experiment-item.locked { opacity: 0.5; cursor: not-allowed; border-left-color: #666; }
        .resource-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .resource-box { background: rgba(100, 200, 255, 0.1); padding: 10px; border-radius: 6px; text-align: center; }
        .resource-box .value { font-size: 1.4em; font-weight: bold; color: #64c8ff; } .resource-box .label { font-size: 0.8em; color: #888; margin-top: 5px; }
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; padding: 10px; background: rgba(100, 200, 255, 0.05); border-radius: 6px; }
        .toggle-switch input[type="checkbox"] { width: 50px; height: 25px; -webkit-appearance: none; appearance: none; background: rgba(100, 100, 100, 0.5); outline: none; border-radius: 25px; cursor: pointer; position: relative; transition: 0.3s; }
        .toggle-switch input[type="checkbox"]:checked { background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); }
        .toggle-switch input[type="checkbox"]::before { content: ''; position: absolute; width: 21px; height: 21px; border-radius: 50%; top: 2px; left: 2px; background: white; transition: 0.3s; }
        .toggle-switch input[type="checkbox"]:checked::before { left: 27px; }
        .slider-control { margin: 15px 0; } .slider-control label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; }
        .slider-control input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; appearance: none; background: rgba(100, 200, 255, 0.2); outline: none; border-radius: 3px; }
        .slider-control input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); cursor: pointer; border-radius: 50%; }
        .notification {
            position: absolute; top: 20px; right: 20px; background: rgba(15, 15, 35, 0.95);
            border: 1px solid rgba(100, 200, 255, 0.5); border-radius: 10px; padding: 15px 20px;
            min-width: 300px; backdrop-filter: blur(10px); animation: slideIn 0.3s ease; z-index: 1000;
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { border-color: #00ff88; } .notification.warning { border-color: #ffaa00; } .notification.error { border-color: #ff4444; }
        .event-timer { font-size: 0.8em; color: #ffaa00; margin-top: 5px; }
        .tooltip {
            position: fixed; background: rgba(15,15,35,0.95); border: 1px solid rgba(100,200,255,0.5);
            border-radius: 8px; padding: 8px 10px; font-size: 12px; color: #e0e0e0;
            pointer-events: none; transform: translate(-50%, -140%); white-space: nowrap; z-index: 2000;
        }
        .tooltip .title { color:#64c8ff; font-weight:600; } .tooltip .sub { color:#aaa; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header"><h1>üåå IA C√≥smica</h1><p>Sistema de Explora√ß√£o Universal</p></div>
            <div class="level-display" id="levelDisplay"><div class="level">N√≠vel 1</div><div class="score">Pontua√ß√£o: 0</div></div>
            <div class="nav-section"><h3>Explora√ß√£o</h3>
                <button class="nav-button active" onclick="changeMode('exploration')">üî≠ Mapeamento Estelar</button>
                <button class="nav-button locked" onclick="changeMode('discovery')">üåç Descoberta de Planetas</button>
                <button class="nav-button locked" onclick="changeMode('anomalies')">‚ö° Anomalias C√≥smicas</button>
            </div>
            <div class="nav-section"><h3>Coloniza√ß√£o</h3>
                <button class="nav-button locked" onclick="changeMode('colonies')">üèóÔ∏è Col√¥nias Ativas</button>
                <button class="nav-button locked" onclick="changeMode('terraform')">üå± Terraforma√ß√£o</button>
                <button class="nav-button locked" onclick="changeMode('infrastructure')">üè≠ Infraestrutura</button>
            </div>
            <div class="nav-section"><h3>Experimentos</h3>
                <button class="nav-button locked" onclick="changeMode('physics')">‚öõÔ∏è F√≠sica Qu√¢ntica</button>
                <button class="nav-button locked" onclick="changeMode('biology')">üß¨ Biologia Espacial</button>
                <button class="nav-button locked" onclick="changeMode('energy')">‚ö° Energia Ex√≥tica</button>
            </div>
            <div class="nav-section"><h3>Recursos</h3>
                <button class="nav-button locked" onclick="changeMode('resources')">üíé Gest√£o de Recursos</button>
                <button class="nav-button locked" onclick="changeMode('trade')">üîÑ Com√©rcio Interestelar</button>
            </div>
        </div><!-- Fim da sidebar -->

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div class="status-indicators">
                    <div class="status-item">
                        <div class="status-dot green"></div>
                        <span>Sistemas Online</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot blue"></div>
                        <span id="currentSector">Explorando: Setor 7G</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot purple"></div>
                        <span id="activeExperiments">5 Experimentos Ativos</span>
                    </div>
                </div>
                <div>
                    <span style="font-size: 0.9em;" id="galacticYear">üïê Ano Gal√°ctico: 2847.3</span>
                </div>
            </div>

            <div class="content-area">
                <div class="canvas-container">
                    <canvas id="cosmicCanvas"></canvas>

                    <!-- Canvas Controls -->
                    <div class="canvas-controls">
                        <button class="control-btn" onclick="resetView()" title="Resetar Visualiza√ß√£o">üéØ</button>
                        <button class="control-btn" onclick="zoomIn()" title="Aumentar Zoom">‚ûï</button>
                        <button class="control-btn" onclick="zoomOut()" title="Diminuir Zoom">‚ûñ</button>
                        <div class="zoom-display" id="zoomDisplay">100%</div>
                        <button class="control-btn" onclick="togglePause()" id="pauseBtn" title="Pausar/Retomar">‚è∏Ô∏è</button>
                    </div>
                </div>

                <!-- Painel de Informa√ß√µes -->
                <div class="info-panel">
                    <h2 id="panelTitle">Mapeamento Estelar</h2>

                    <div id="panelContent">
                        <!-- O conte√∫do dos m√≥dulos ser√° injetado via JS (pr√≥xima parte) -->
                    </div>

                    <div class="info-card">
                        <h3>Recursos Dispon√≠veis</h3>
                        <div class="resource-grid">
                            <div class="resource-box">
                                <div class="value" id="energyValue">8742</div>
                                <div class="label">‚ö° Energia</div>
                            </div>
                            <div class="resource-box">
                                <div class="value" id="materialsValue">5621</div>
                                <div class="label">üîß Materiais</div>
                            </div>
                            <div class="resource-box">
                                <div class="value" id="dataValue">12483</div>
                                <div class="label">üìä Dados</div>
                            </div>
                            <div class="resource-box">
                                <div class="value" id="creditsValue">45920</div>
                                <div class="label">üí∞ Cr√©ditos</div>
                            </div>
                        </div>
                    </div>
                </div><!-- fim info-panel -->
            </div><!-- fim content-area -->
        </div><!-- fim main-content -->
    </div><!-- fim .container -->

    <!-- Parte 3 (JS completo: canvas, c√¢mera, modos, economia, IA, save/load) vir√° a seguir -->
    <script>
        // ========================= CONFIGURA√á√ÉO DO CANVAS =========================
        const canvas = document.getElementById('cosmicCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Sistema de c√¢mera e controles
        let camera = { x: 0, y: 0, zoom: 1, targetZoom: 1, isDragging: false, dragStartX: 0, dragStartY: 0 };
        let isPaused = false;
        let selectedPlanet = null;

        // Mouse e controles de zoom
        canvas.addEventListener('mousedown', (e) => {
            camera.isDragging = true;
            camera.dragStartX = e.clientX - camera.x;
            camera.dragStartY = e.clientY - camera.y;
        });
        canvas.addEventListener('mousemove', (e) => {
            if (camera.isDragging) {
                camera.x = e.clientX - camera.dragStartX;
                camera.y = e.clientY - camera.dragStartY;
            }
        });
        canvas.addEventListener('mouseup', () => { camera.isDragging = false; });
        canvas.addEventListener('mouseleave', () => { camera.isDragging = false; });
        canvas.addEventListener('click', (e) => {
            if (camera.isDragging) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left - camera.x) / camera.zoom;
            const mouseY = (e.clientY - rect.top - camera.y) / camera.zoom;
            planets.forEach(planet => {
                if (Math.hypot(mouseX - planet.x, mouseY - planet.y) < planet.radius) {
                    selectPlanet(planet);
                }
            });
        });
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomSpeed = 0.1;
            camera.targetZoom = Math.max(0.5, Math.min(3, camera.targetZoom + (e.deltaY > 0 ? -zoomSpeed : zoomSpeed)));
        });

        // Fun√ß√µes de controle da UI
        function zoomIn() { camera.targetZoom = Math.min(3, camera.targetZoom + 0.2); }
        function zoomOut() { camera.targetZoom = Math.max(0.5, camera.targetZoom - 0.2); }
        function resetView() { camera.x = 0; camera.y = 0; camera.targetZoom = 1; showNotification('Visualiza√ß√£o resetada', 'success'); }
        function togglePause() { isPaused = !isPaused; document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'; }

        // ========================= SISTEMA DE PLANETAS =========================
        const planets = [
            { x: 0, y: 0, radius: 40, color: '#ff6b35', name: 'Kepler-442b', orbitRadius: 180, angle: 0, speed: 0.008, population: 0, habitability: 87, resources: 'Alto', status: 'Descoberto', type: 'Terrestre' },
            { x: 0, y: 0, radius: 30, color: '#4ecdc4', name: 'Proxima b', orbitRadius: 250, angle: 1.5, speed: 0.012, population: 1200000, habitability: 92, resources: 'M√©dio', status: 'Colonizado', type: 'Oce√¢nico' },
            { x: 0, y: 0, radius: 50, color: '#95e1d3', name: 'TRAPPIST-1e', orbitRadius: 350, angle: 3, speed: 0.006, population: 450000, habitability: 78, resources: 'Muito Alto', status: 'Em Terraforma√ß√£o', type: 'Terrestre' },
            { x: 0, y: 0, radius: 25, color: '#f38181', name: 'LHS 1140b', orbitRadius: 140, angle: 4, speed: 0.015, population: 0, habitability: 65, resources: 'Baixo', status: 'Em Estudo', type: 'Superterrestre' },
            { x: 0, y: 0, radius: 35, color: '#a8e6cf', name: 'Wolf 1061c', orbitRadius: 420, angle: 2, speed: 0.005, population: 8000, habitability: 71, resources: 'Alto', status: 'Base Estabelecida', type: 'Rochoso' }
        ];
        const centerX = () => canvas.getBoundingClientRect().width / 2;
        const centerY = () => canvas.getBoundingClientRect().height / 2;

        // Sistema de estrelas de fundo
        const stars = [];
        for (let i = 0; i < 300; i++) {
            stars.push({ x: Math.random() * 2000 - 1000, y: Math.random() * 2000 - 1000, radius: Math.random() * 1.5, baseSpeed: Math.random() * 0.3 + 0.1, brightness: Math.random() });
        }
        let animationTime = 0;

        // Loop de anima√ß√£o principal
        function animate() {
            const rect = canvas.getBoundingClientRect();
            ctx.clearRect(0, 0, rect.width, rect.height);
            camera.zoom += (camera.targetZoom - camera.zoom) * 0.1;
            document.getElementById('zoomDisplay').textContent = Math.round(camera.zoom * 100) + '%';
            ctx.save(); ctx.translate(camera.x, camera.y); ctx.scale(camera.zoom, camera.zoom);

            // Renderizar estrelas
            stars.forEach(star => {
                ctx.beginPath(); ctx.arc(centerX() + star.x, centerY() + star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${0.3 + star.brightness * 0.7})`;
                ctx.fill();
                if (!isPaused) star.brightness = 0.3 + Math.sin(animationTime * 0.001 + star.x) * 0.7;
            });

            // Renderizar estrela central
            const gradient = ctx.createRadialGradient(centerX(), centerY(), 0, centerX(), centerY(), 70);
            gradient.addColorStop(0, '#fff9e6'); gradient.addColorStop(0.3, '#ffd700'); gradient.addColorStop(0.6, '#ffaa00'); gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
            ctx.fillStyle = gradient; ctx.beginPath(); ctx.arc(centerX(), centerY(), 70, 0, Math.PI * 2); ctx.fill();

            // Renderizar planetas
            planets.forEach(planet => {
                if (!isPaused) planet.angle += planet.speed;
                planet.x = centerX() + Math.cos(planet.angle) * planet.orbitRadius;
                planet.y = centerY() + Math.sin(planet.angle) * planet.orbitRadius;
                ctx.beginPath(); ctx.arc(centerX(), centerY(), planet.orbitRadius, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(100, 200, 255, 0.15)'; ctx.lineWidth = 1; ctx.stroke();

                const planetGradient = ctx.createRadialGradient(planet.x - planet.radius * 0.3, planet.y - planet.radius * 0.3, planet.radius * 0.1, planet.x, planet.y, planet.radius);
                planetGradient.addColorStop(0, planet.color); planetGradient.addColorStop(0.7, planet.color); planetGradient.addColorStop(1, '#1a1047');
                ctx.fillStyle = planetGradient; ctx.beginPath(); ctx.arc(planet.x, planet.y, planet.radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = planet.color; ctx.lineWidth = 2; ctx.stroke();
                ctx.shadowBlur = 15; ctx.shadowColor = planet.color; ctx.beginPath(); ctx.arc(planet.x, planet.y, planet.radius + 2, 0, Math.PI * 2);
                ctx.strokeStyle = `${planet.color}88`; ctx.lineWidth = 3; ctx.stroke(); ctx.shadowBlur = 0;

                // Renderiza√ß√£o n√≠tida de texto
                ctx.save(); const currentTransform = ctx.getTransform(); ctx.setTransform(1, 0, 0, 1, 0, 0);
                const textX = currentTransform.e + planet.x * currentTransform.a;
                const textY = currentTransform.f + (planet.y + planet.radius + 15) * currentTransform.d;
                ctx.fillStyle = '#e0e0e0'; ctx.font = 'bold 13px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(planet.name, textX, textY);
                if (planet.population > 0) { ctx.fillStyle = '#00ff88'; ctx.font = '11px Arial'; ctx.fillText(`üë• ${fmt(planet.population)}`, textX, textY + 16); }
                ctx.restore();
            });

            ctx.restore();
            if (!isPaused) animationTime += 16;
            requestAnimationFrame(animate);
        }
        animate();

        // ========================= SISTEMA DE ECONOMIA E PROGRESS√ÉO =========================
        const Game = {
            tickMs: 1000, level: 1, score: 0, unlocked: new Set(['exploration']),
            missions: [
                { id: 'scan1', text: 'Realize 1 varredura profunda', done: false, reward: { credits: 500, unlock: 'discovery' } },
                { id: 'colonize1', text: 'Colonize 1 planeta', done: false, reward: { materials: 800, unlock: 'colonies' } },
                { id: 'infra1', text: 'Construa 1 instala√ß√£o', done: false, reward: { energy: 600, unlock: 'infrastructure' } },
                { id: 'trade1', text: 'Conclua 1 oferta de com√©rcio', done: false, reward: { credits: 1200, unlock: 'trade' } }
            ],
            resources: { energy: 8742, materials: 5621, data: 12483, credits: 45920 },
            rates: { energy: 6, materials: 4, data: 8, credits: 12 },
            storage: { cap: 100000 },
            colonies: 0, population: 0,
            victory: { population: 2000000, colonies: 3 }, defeat: { aiColonies: 3 },
            ai: { name: 'Alian√ßa TRAPPIST', colonies: 0, progress: 0, rate: 0.07 }
        };

        const Costs = {
            deepScan: { energy: 150, data: 300 }, deployProbe: { energy: 120, data: 120 },
            colonize: { materials: 2500, energy: 1200, credits: 1500 }, expand: { materials: 1800, energy: 900, credits: 900 },
            terraformBoost: { energy: 2000, materials: 1200, data: 800 },
            build: { station: { materials: 5000, energy: 2500, credits: 2000 }, mine: { materials: 3000, energy: 1200, credits: 800 }, solar: { materials: 2000, energy: 800, credits: 600 }, lab: { materials: 4000, energy: 1800, data: 1200 } },
            tradeDeal: { data: 150 }
        };

        const Events = [
            { text: 'Tempestade solar fortaleceu pain√©is', effect: () => gain({ energy: 1200 }) },
            { text: 'Falha em laborat√≥rio consumiu materiais', effect: () => spend({ materials: 800 }) },
            { text: 'Descoberta cient√≠fica gerou dados', effect: () => gain({ data: 1500 }) },
            { text: 'Crise log√≠stica reduziu cr√©ditos', effect: () => spend({ credits: 1200 }) }
        ];

        function fmt(n) { return n >= 1e6 ? (n / 1e6).toFixed(1) + 'M' : n >= 1e3 ? (n / 1e3).toFixed(1) + 'K' : String(n); }
        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
        function has(cost) { return Object.entries(cost).every(([k, v]) => Game.resources[k] >= v); }
        function spend(cost) {
            if (!has(cost)) { showNotification('Recursos insuficientes', 'error'); return false; }
            Object.entries(cost).forEach(([k, v]) => { Game.resources[k] -= v; });
            updateResourcesUI(); return true;
        }
        function gain(obj) {
            Object.entries(obj).forEach(([k, v]) => {
                Game.resources[k] = clamp(Game.resources[k] + v, 0, Game.storage.cap);
            });
            updateResourcesUI();
        }

        function updateResourcesUI() {
            const ids = { energy: 'energyValue', materials: 'materialsValue', data: 'dataValue', credits: 'creditsValue' };
            Object.entries(ids).forEach(([k, id]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = Math.floor(Game.resources[k]);
            });
        }

        function updateLevelDisplay() {
            const el = document.getElementById('levelDisplay');
            if (el) {
                el.innerHTML = `<div class="level">N√≠vel ${Game.level}</div><div class="score">Pontua√ß√£o: ${fmt(Game.score)}</div>`;
            }
        }

        // ========================= SISTEMA DE MISS√ïES E DESBLOQUEIOS =========================
        function completeMission(id) {
            const m = Game.missions.find(x => x.id === id);
            if (m && !m.done) {
                m.done = true;
                if (m.reward) {
                    gain(m.reward);
                    if (m.reward.unlock) unlockModule(m.reward.unlock);
                }
                showNotification(`Miss√£o conclu√≠da: ${m.text} üéâ`);
                Game.level += 1;
                updateLevelDisplay();
            }
        }

        function unlockModule(key) {
            Game.unlocked.add(key);
            const map = {
                discovery: 'Descoberta de Planetas', colonies: 'Col√¥nias Ativas',
                infrastructure: 'Infraestrutura', trade: 'Com√©rcio Interestelar'
            };
            showNotification(`M√≥dulo desbloqueado: ${map[key] || key}`);
            // Atualiza bot√µes da sidebar
            document.querySelectorAll('.nav-button').forEach(btn => {
                if (btn.textContent.includes(map[key] || '')) {
                    btn.classList.remove('locked');
                }
            });
        }

        // ========================= M√ìDULOS DE CONTE√öDO =========================
        const modeContent = {
            exploration: {
                title: 'Mapeamento Estelar',
                html: `
                    <div class="info-card">
                        <h3>Sistema Atual: Alfa Centauri B</h3>
                        <div class="info-row"><span class="info-label">Tipo Estelar:</span><span class="info-value">K1V</span></div>
                        <div class="info-row"><span class="info-label">Dist√¢ncia:</span><span class="info-value">4.37 anos-luz</span></div>
                        <div class="info-row"><span class="info-label">Planetas:</span><span class="info-value">${planets.length} detectados</span></div>
                        <div class="info-row"><span class="info-label">Progresso:</span><span class="info-value">73%</span></div>
                        <div class="progress-bar"><div class="progress-fill" style="width: 73%"></div></div>
                    </div>
                    <div class="info-card">
                        <h3>Descobertas Recentes</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item">üåç Planeta Class-M (HD 40307g)</li>
                            <li class="experiment-item">‚òÑÔ∏è Campo de Asteroides Rico em Platina</li>
                            <li class="experiment-item">üåü An√£ Marrom Isolada</li>
                            <li class="experiment-item">üîÆ Anomalia Gravitacional</li>
                        </ul>
                    </div>
                    <button class="action-button" onclick="startDeepScan()">üîç Varredura Profunda</button>
                    <button class="action-button secondary" onclick="deployProbe()">üõ∞Ô∏è Enviar Sonda</button>
                `
            },
            discovery: {
                title: 'Descoberta de Planetas',
                html: `
                    <div class="info-card">
                        <h3>Planetas Descobertos</h3>
                        <div class="info-row"><span class="info-label">Total:</span><span class="info-value">${planets.length} planetas</span></div>
                        <div class="info-row"><span class="info-label">Habit√°veis:</span><span class="info-value">${planets.filter(p => p.habitability > 70).length}</span></div>
                        <div class="info-row"><span class="info-label">Colonizados:</span><span class="info-value">${planets.filter(p => p.population > 0).length}</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Lista de Planetas</h3>
                        <ul class="experiment-list">
                            ${planets.map(p => `
                                <li class="experiment-item" onclick="selectPlanetByName('${p.name}')">
                                    ${p.population > 0 ? 'üèôÔ∏è' : 'üåç'} ${p.name} (${p.habitability}%)
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <button class="action-button" onclick="searchNewPlanets()">üî≠ Buscar Novos Planetas</button>
                `
            },
            anomalies: {
                title: 'Anomalias C√≥smicas',
                html: `
                    <div class="info-card">
                        <h3>Anomalias Detectadas</h3>
                        <div class="info-row"><span class="info-label">Total Ativas:</span><span class="info-value">7 anomalias</span></div>
                        <div class="info-row"><span class="info-label">N√≠vel de Risco:</span><span class="info-value" style="color: #ffaa00;">M√©dio</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Lista de Anomalias</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item">‚ö´ Buraco Negro Errante (3.2 AL)</li>
                            <li class="experiment-item">üåÄ Distor√ß√£o Espa√ßo-Temporal</li>
                            <li class="experiment-item">‚ö° Tempestade de Radia√ß√£o</li>
                            <li class="experiment-item">üîÆ Sinal N√£o Identificado</li>
                            <li class="experiment-item">üí´ Nuvem de Mat√©ria Escura</li>
                        </ul>
                    </div>
                    <button class="action-button" onclick="investigateAnomaly()">üî¨ Investigar Anomalia</button>
                `
            },
            colonies: {
                title: 'Col√¥nias Ativas',
                html: `
                    <div class="info-card">
                        <h3>Vis√£o Geral</h3>
                        <div class="info-row"><span class="info-label">Total de Col√¥nias:</span><span class="info-value">${planets.filter(p => p.population > 0).length}</span></div>
                        <div class="info-row"><span class="info-label">Popula√ß√£o Total:</span><span class="info-value">${fmt(planets.reduce((sum, p) => sum + p.population, 0))}</span></div>
                        <div class="info-row"><span class="info-label">Taxa de Crescimento:</span><span class="info-value">+2.3% /ano</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Col√¥nias Estabelecidas</h3>
                        <ul class="experiment-list">
                            ${planets.filter(p => p.population > 0).map(p => `
                                <li class="experiment-item" onclick="selectPlanetByName('${p.name}')">
                                    üèôÔ∏è ${p.name} - ${fmt(p.population)} hab.
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <button class="action-button" onclick="establishNewColony()">üèóÔ∏è Estabelecer Nova Col√¥nia</button>
                    <button class="action-button secondary" onclick="manageAllColonies()">‚öôÔ∏è Gerenciar Todas</button>
                `
            },
            terraform: {
                title: 'Terraforma√ß√£o',
                html: `
                    <div class="info-card">
                        <h3>Projeto Ativo: TRAPPIST-1e</h3>
                        <div class="info-row"><span class="info-label">Progresso Geral:</span><span class="info-value">64%</span></div>
                        <div class="progress-bar"><div class="progress-fill" style="width: 64%"></div></div>
                        <div class="info-row" style="margin-top: 10px;"><span class="info-label">Tempo Restante:</span><span class="info-value">14h 32min</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Par√¢metros Ambientais</h3>
                        <div class="slider-control">
                            <label><span>üå°Ô∏è Temperatura:</span><span id="tempValue">18¬∞C</span></label>
                            <input type="range" min="-50" max="50" value="18" oninput="updateSlider('temp', this.value)">
                        </div>
                        <div class="slider-control">
                            <label><span>üí® Press√£o Atmosf√©rica:</span><span id="pressureValue">1.02 atm</span></label>
                            <input type="range" min="0" max="200" value="102" oninput="updateSlider('pressure', this.value)">
                        </div>
                        <div class="slider-control">
                            <label><span>üíß Umidade:</span><span id="humidityValue">45%</span></label>
                            <input type="range" min="0" max="100" value="45" oninput="updateSlider('humidity', this.value)">
                        </div>
                    </div>
                    <div class="info-card">
                        <h3>Processos Ativos</h3>
                        <div class="toggle-switch"><span>Bombardeamento de Cometas</span><input type="checkbox" checked onchange="toggleProcess('comets')"></div>
                        <div class="toggle-switch"><span>Gera√ß√£o de Atmosfera</span><input type="checkbox" checked onchange="toggleProcess('atmosphere')"></div>
                        <div class="toggle-switch"><span>Semeadura Biol√≥gica</span><input type="checkbox" onchange="toggleProcess('bio')"></div>
                    </div>
                    <button class="action-button" onclick="accelerateTerraform()">‚ö° Acelerar Processo</button>
                `
            },
            infrastructure: {
                title: 'Infraestrutura',
                html: `
                    <div class="info-card">
                        <h3>Instala√ß√µes Constru√≠das</h3>
                        <div class="info-row"><span class="info-label">Esta√ß√µes Orbitais:</span><span class="info-value">12</span></div>
                        <div class="info-row"><span class="info-label">Bases Planet√°rias:</span><span class="info-value">8</span></div>
                        <div class="info-row"><span class="info-label">Minas de Asteroides:</span><span class="info-value">15</span></div>
                        <div class="info-row"><span class="info-label">Coletores Solares:</span><span class="info-value">24</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Constru√ß√£o em Andamento</h3>
                        <div class="info-row"><span class="info-label">Esta√ß√£o Comercial K-7:</span><span class="info-value">47%</span></div>
                        <div class="progress-bar"><div class="progress-fill" style="width: 47%"></div></div>
                        <div class="info-row" style="margin-top: 10px;"><span class="info-label">Tempo Restante:</span><span class="info-value">14h 32min</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Novas Constru√ß√µes</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item" onclick="buildStructure('station')">üõ∞Ô∏è Esta√ß√£o Orbital (5000 ‚ö°)</li>
                            <li class="experiment-item" onclick="buildStructure('mine')">‚õèÔ∏è Mina de Asteroides (3000 ‚ö°)</li>
                            <li class="experiment-item" onclick="buildStructure('solar')">‚òÄÔ∏è Coletor Solar (2000 ‚ö°)</li>
                            <li class="experiment-item" onclick="buildStructure('lab')">üî¨ Laborat√≥rio (4000 ‚ö°)</li>
                        </ul>
                    </div>
                `
            },
            physics: {
                title: 'F√≠sica Qu√¢ntica',
                html: `
                    <div class="info-card">
                        <h3>Experimento Ativo</h3>
                        <div class="info-row"><span class="info-label">Tipo:</span><span class="info-value">Entrela√ßamento Qu√¢ntico</span></div>
                        <div class="info-row"><span class="info-label">Progresso:</span><span class="info-value">62%</span></div>
                        <div class="progress-bar"><div class="progress-fill" style="width: 62%"></div></div>
                        <div class="info-row" style="margin-top: 10px;"><span class="info-label">Tempo Restante:</span><span class="info-value">3h 18min</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Experimentos Dispon√≠veis</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item" onclick="startPhysicsExperiment('warp')">üöÄ Teste de Motor de Curvatura</li>
                            <li class="experiment-item" onclick="startPhysicsExperiment('dark')">üîÆ An√°lise de Mat√©ria Escura</li>
                            <li class="experiment-item" onclick="startPhysicsExperiment('vacuum')">‚ö° Coleta de Energia do V√°cuo</li>
                            <li class="experiment-item" onclick="startPhysicsExperiment('gravity')">üåÄ Manipula√ß√£o Gravitacional</li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h3>Descobertas</h3>
                        <div class="info-row"><span class="info-label">Part√≠culas Ex√≥ticas:</span><span class="info-value">7 tipos</span></div>
                        <div class="info-row"><span class="info-label">Efici√™ncia Qu√¢ntica:</span><span class="info-value">89%</span></div>
                    </div>
                    <button class="action-button" onclick="accelerateExperiment()">‚ö° Acelerar Experimento</button>
                `
            },
            biology: {
                title: 'Biologia Espacial',
                html: `
                    <div class="info-card">
                        <h3>Pesquisa Atual</h3>
                        <div class="info-row"><span class="info-label">Projeto:</span><span class="info-value">Adapta√ß√£o Humana</span></div>
                        <div class="info-row"><span class="info-label">Progresso:</span><span class="info-value">71%</span></div>
                        <div class="progress-bar"><div class="progress-fill" style="width: 71%"></div></div>
                    </div>
                    <div class="info-card">
                        <h3>Organismos Estudados</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item">ü¶† Bact√©rias Extrem√≥filas (24 esp.)</li>
                            <li class="experiment-item">üå± Flora Alien√≠gena (8 esp.)</li>
                            <li class="experiment-item">üêõ Micro-organismos (15 esp.)</li>
                            <li class="experiment-item">üß¨ DNA Sint√©tico (3 variantes)</li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h3>Novos Projetos</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item" onclick="startBioExperiment('adaptation')">üß¨ Engenharia Gen√©tica Adaptativa</li>
                            <li class="experiment-item" onclick="startBioExperiment('crops')">üåæ Culturas para Baixa Gravidade</li>
                            <li class="experiment-item" onclick="startBioExperiment('life')">üî¨ Busca por Vida Microbiana</li>
                        </ul>
                    </div>
                    <button class="action-button" onclick="catalogSpecies()">üìã Catalogar Esp√©cies</button>
                `
            },
            energy: {
                title: 'Energia Ex√≥tica',
                html: `
                    <div class="info-card">
                        <h3>Gera√ß√£o de Energia</h3>
                        <div class="info-row"><span class="info-label">Produ√ß√£o Total:</span><span class="info-value">342 UN/h</span></div>
                        <div class="info-row"><span class="info-label">Consumo:</span><span class="info-value">287 UN/h</span></div>
                        <div class="info-row"><span class="info-label">Excedente:</span><span class="info-value" style="color: #00ff88;">+55 UN/h</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Fontes de Energia</h3>
                        <div class="info-row"><span class="info-label">‚òÄÔ∏è Solar:</span><span class="info-value">45%</span></div>
                        <div class="info-row"><span class="info-label">‚öõÔ∏è Fus√£o Nuclear:</span><span class="info-value">32%</span></div>
                        <div class="info-row"><span class="info-label">üîÆ Antimat√©ria:</span><span class="info-value">15%</span></div>
                        <div class="info-row"><span class="info-label">‚ö° V√°cuo Qu√¢ntico:</span><span class="info-value">8%</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Pesquisas Ativas</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item" onclick="researchEnergy('dyson')">‚≠ê Esfera de Dyson Parcial</li>
                            <li class="experiment-item" onclick="researchEnergy('zero')">üåÄ Extra√ß√£o de Ponto Zero</li>
                            <li class="experiment-item" onclick="researchEnergy('antimatter')">üí• Gerador de Antimat√©ria</li>
                        </ul>
                    </div>
                    <button class="action-button" onclick="optimizeEnergy()">‚ö° Otimizar Rede Energ√©tica</button>
                `
            },
            resources: {
                title: 'Gest√£o de Recursos',
                html: `
                    <div class="info-card">
                        <h3>Produ√ß√£o Hor√°ria</h3>
                        <div class="info-row"><span class="info-label">‚ö° Energia:</span><span class="info-value" style="color: #00ff88;">+342</span></div>
                        <div class="info-row"><span class="info-label">üîß Materiais:</span><span class="info-value" style="color: #00ff88;">+218</span></div>
                        <div class="info-row"><span class="info-label">üìä Dados:</span><span class="info-value" style="color: #00ff88;">+567</span></div>
                        <div class="info-row"><span class="info-label">üí∞ Cr√©ditos:</span><span class="info-value" style="color: #00ff88;">+892</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Fontes de Recursos</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item">‚òÄÔ∏è Coletores Solares (x24)</li>
                            <li class="experiment-item">‚õèÔ∏è Minas de Asteroides (x15)</li>
                            <li class="experiment-item">üî¨ Laborat√≥rios (x8)</li>
                            <li class="experiment-item">üè≠ Complexos Industriais (x6)</li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h3>Armazenamento</h3>
                        <div class="info-row"><span class="info-label">Capacidade Usada:</span><span class="info-value">67%</span></div>
                        <div class="progress-bar"><div class="progress-fill" style="width: 67%"></div></div>
                    </div>
                    <button class="action-button" onclick="expandStorage()">üì¶ Expandir Armazenamento</button>
                    <button class="action-button secondary" onclick="optimizeProduction()">‚öôÔ∏è Otimizar Produ√ß√£o</button>
                `
            },
            trade: {
                title: 'Com√©rcio Interestelar',
                html: `
                    <div class="info-card">
                        <h3>Rotas Comerciais Ativas</h3>
                        <div class="info-row"><span class="info-label">Total de Rotas:</span><span class="info-value">8 rotas</span></div>
                        <div class="info-row"><span class="info-label">Volume Di√°rio:</span><span class="info-value">12.4K unidades</span></div>
                        <div class="info-row"><span class="info-label">Lucro/dia:</span><span class="info-value" style="color: #00ff88;">+4.2K üí∞</span></div>
                    </div>
                    <div class="info-card">
                        <h3>Parceiros Comerciais</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item">üåç Federa√ß√£o de Proxima (Ativo)</li>
                            <li class="experiment-item">üöÄ Cons√≥rcio de Kepler (Ativo)</li>
                            <li class="experiment-item">üí´ Alian√ßa TRAPPIST (Ativo)</li>
                            <li class="experiment-item">‚≠ê Uni√£o Wolf (Pendente)</li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h3>Ofertas Dispon√≠veis</h3>
                        <ul class="experiment-list">
                            <li class="experiment-item" onclick="acceptTrade(1)">üì¶ 500 Materiais por 2K üí∞</li>
                            <li class="experiment-item" onclick="acceptTrade(2)">‚ö° 1K Energia por 300 Dados</li>
                            <li class="experiment-item" onclick="acceptTrade(3)">üî¨ Tecnologia Avan√ßada por 5K üí∞</li>
                        </ul>
                    </div>
                    <button class="action-button" onclick="openTradeNegotiation()">ü§ù Negociar Novo Acordo</button>
                `
            }
        };

        // ========================= SISTEMA DE NAVEGA√á√ÉO E TOOLTIP =========================
        function changeMode(mode) {
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (modeContent[mode]) {
                document.getElementById('panelTitle').textContent = modeContent[mode].title;
                document.getElementById('panelContent').innerHTML = modeContent[mode].html;
            }
        }

        let tooltipEl;
        function ensureTooltip() {
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.className = 'tooltip';
                tooltipEl.style.display = 'none';
                document.body.appendChild(tooltipEl);
            }
        }
        ensureTooltip();

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - camera.x) / camera.zoom;
            const my = (e.clientY - rect.top - camera.y) / camera.zoom;
            let hover = null;
            planets.forEach(p => { if (Math.hypot(mx - p.x, my - p.y) < p.radius) hover = p; });
            if (hover) {
                tooltipEl.style.left = e.clientX + 'px';
                tooltipEl.style.top = e.clientY + 'px';
                tooltipEl.innerHTML = `<div class="title">${hover.name}</div><div class="sub">Hab: ${hover.habitability}% ‚Ä¢ Rec: ${hover.resources}</div>${hover.population > 0 ? `<div class="sub">Pop: ${fmt(hover.population)}</div>` : ''}`;
                tooltipEl.style.display = 'block';
            } else {
                tooltipEl.style.display = 'none';
            }
        });

        // ========================= SISTEMA DE ECONOMIA E A√á√ïES =========================
        const Costs = {
            deepScan: { energy: 150, data: 300 }, deployProbe: { energy: 120, data: 120 },
            colonize: { materials: 2500, energy: 1200, credits: 1500 }, expand: { materials: 1800, energy: 900, credits: 900 },
            terraformBoost: { energy: 2000, materials: 1200, data: 800 },
            build: {
                station: { materials: 5000, energy: 2500, credits: 2000 },
                mine: { materials: 3000, energy: 1200, credits: 800 },
                solar: { materials: 2000, energy: 800, credits: 600 },
                lab: { materials: 4000, energy: 1800, data: 1200 }
            },
            tradeDeal: { data: 150 }
        };

        const Events = [
            { text: 'Tempestade solar fortaleceu pain√©is', effect: () => gain({ energy: 1200 }) },
            { text: 'Falha em laborat√≥rio consumiu materiais', effect: () => spend({ materials: 800 }) },
            { text: 'Descoberta cient√≠fica gerou dados', effect: () => gain({ data: 1500 }) },
            { text: 'Crise log√≠stica reduziu cr√©ditos', effect: () => spend({ credits: 1200 }) }
        ];

        // A√ß√µes principais (com custos)
        function startDeepScan() {
            if (!spend(Costs.deepScan)) return;
            showNotification('üîç Varredura profunda iniciada! Tempo estimado: 2h 34min');
            completeMission('scan1');
            Game.score += 50;
        }

        function deployProbe() {
            if (!spend(Costs.deployProbe)) return;
            showNotification('üõ∞Ô∏è Sonda de explora√ß√£o implantada! Destino: Sistema HD 40307');
            Game.score += 20;
        }

        function colonizePlanet(name) {
            const p = planets.find(x => x.name === name);
            if (!p || !spend(Costs.colonize) || p.population > 0) {
                if (p.population > 0) showNotification('Planeta j√° colonizado', 'warning');
                return;
            }
            p.population = 5000; p.status = 'Colonizado'; Game.colonies += 1; Game.population += p.population;
            updatePanelForPlanet(p); showNotification(`Coloniza√ß√£o iniciada em ${name}!`);
            completeMission('colonize1'); Game.score += 200;
        }

        function expandColony(name) {
            const p = planets.find(x => x.name === name);
            if (!p || p.population <= 0 || !spend(Costs.expand)) return;
            const inc = Math.floor(p.population * 0.25) + 2000;
            p.population += inc; Game.population += inc;
            updatePanelForPlanet(p); showNotification(`Col√¥nia expandida em ${name} (+${fmt(inc)} hab.)`);
            Game.score += 120;
        }

        function buildStructure(type) {
            const cost = Costs.build[type];
            if (!cost || !spend(cost)) return;
            showNotification('Constru√ß√£o iniciada!'); completeMission('infra1'); Game.score += 100;
        }

        function acceptTrade(id) {
            if (!spend(Costs.tradeDeal)) return;
            if (id === 1) gain({ materials: 500, credits: 2000 });
            if (id === 2) gain({ energy: 1000, data: -300 });
            if (id === 3) spend({ credits: 5000 });
            showNotification('Neg√≥cio conclu√≠do!'); completeMission('trade1'); Game.score += 60;
        }

        // ========================= MISS√ïES E DESBLOQUEIOS =========================
        function completeMission(id) {
            const m = Game.missions.find(x => x.id === id);
            if (m && !m.done) {
                m.done = true;
                if (m.reward) {
                    gain(m.reward);
                    if (m.reward.unlock) unlockModule(m.reward.unlock);
                }
                showNotification(`Miss√£o conclu√≠da: ${m.text} üéâ`);
                Game.level += 1; updateLevelDisplay();
            }
        }

        function unlockModule(key) {
            Game.unlocked.add(key);
            const map = {
                discovery: 'Descoberta de Planetas', colonies: 'Col√¥nias Ativas',
                infrastructure: 'Infraestrutura', trade: 'Com√©rcio Interestelar'
            };
            showNotification(`M√≥dulo desbloqueado: ${map[key] || key}`);
            document.querySelectorAll('.nav-button').forEach(btn => {
                if (btn.textContent.includes(map[key] || '')) btn.classList.remove('locked');
            });
        }

        // ========================= IA RIVAL E EVENTOS =========================
        function aiTick() {
            Game.ai.progress += Game.ai.rate * (1 + 0.2 * Math.random());
            if (Game.ai.progress >= 1) {
                Game.ai.progress = 0; Game.ai.colonies += 1;
                showNotification(`A IA rival colonizou um novo planeta (total ${Game.ai.colonies})`, 'warning');
            }
        }

        function randomEvent() {
            if (Math.random() < 0.25) {
                const ev = Events[Math.floor(Math.random() * Events.length)];
                ev.effect(); showNotification(`Evento: ${ev.text}`);
            }
        }

        function checkWinLose() {
            if (Game.population >= Game.victory.population || Game.colonies >= Game.victory.colonies) {
                clearInterval(gameLoop); showNotification('Vit√≥ria! Sua civiliza√ß√£o prospera na gal√°xia üéñÔ∏è');
            }
            if (Game.ai.colonies >= Game.defeat.aiColonies) {
                clearInterval(gameLoop); showNotification('Derrota! A IA rival dominou o setor üí•', 'error');
            }
        }

        // ========================= SAVE/LOAD E UTILIDADES =========================
        function saveGame() {
            const snapshot = {
                Game: {
                    tickMs: Game.tickMs, level: Game.level, score: Game.score, unlocked: Array.from(Game.unlocked),
                    missions: Game.missions, resources: Game.resources, rates: Game.rates, storage: Game.storage,
                    colonies: Game.colonies, population: Game.population, victory: Game.victory, defeat: Game.defeat, ai: Game.ai
                },
                planets: planets.map(p => ({ name: p.name, population: p.population, status: p.status }))
            };
            localStorage.setItem('cosmic_game_save', JSON.stringify(snapshot));
            showNotification('Progresso salvo');
        }

        function loadGame() {
            const raw = localStorage.getItem('cosmic_game_save');
            if (!raw) return;
            try {
                const s = JSON.parse(raw);
                Object.assign(Game, s.Game);
                Game.unlocked = new Set(s.Game.unlocked);
                s.planets.forEach(sp => {
                    const p = planets.find(x => x.name === sp.name);
                    if (p) { p.population = sp.population; p.status = sp.status; }
                });
                updateResourcesUI(); updateLevelDisplay();
                showNotification('Progresso carregado');
            } catch (e) {
                showNotification('Falha ao carregar save', 'error');
            }
        }

        // ========================= SISTEMA DE NOTIFICA√á√ïES =========================
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<div style="display: flex; align-items: center; gap: 10px;"><span style="font-size: 1.5em;">${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span><span>${message}</span></div>`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ========================= INICIALIZA√á√ÉO =========================
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); saveGame(); }
            if (e.ctrlKey && e.key.toLowerCase() === 'l') { e.preventDefault(); loadGame(); }
        });

        // Loop econ√¥mico
        let gameLoop = setInterval(() => {
            gain(Game.rates); aiTick(); randomEvent(); checkWinLose();
            const top = document.getElementById('activeExperiments');
            if (top) top.textContent = `Rival: ${Game.ai.colonies} col√¥nias`;
        }, Game.tickMs);

        // Inicializar UI
        updateResourcesUI(); updateLevelDisplay();
        document.getElementById('panelContent').innerHTML = modeContent.exploration.html;
    </script>
</body>
</html>
